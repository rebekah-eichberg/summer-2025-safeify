# Matching Amazon Products to Incident Reports and Recalls

## Overview
This folder contains notebooks and scripts used to match for matching Amazon product metadata to incident and recall reports for toys and childrenâ€™s products. The matching process combines fuzzy string matching, semantic similarity using transformer models, web search enrichment, and large language model (LLM) verification.

## Contents

- **duckduckgo_asins.ipynb**  
  Notebook for extracting ASINs from incident reports using DuckDuckGo search and annotating Amazon metadata with matches.

- **matching_recalls.ipynb**
  Notebook for finding matches between the CPSC recalls and products in the Amazon metadata.

- **MatchWithPretrainedModelandLLM.ipynb**  
  Notebook for robust product matching using fuzzy string matching, transformer-based semantic similarity, and LLM-based verification and refinement.

## Workflow

1. **Web Search Matching:**  
   Use `duckduckgo_asins.ipynb` to find Amazon ASINs for incident reports via DuckDuckGo search.

2. **Matching with recalls:**
  Use `matching_recalls.ipynb` to match products in the amazon product metadata with items in CPSC recall database, saving the output to `../Data/amazon_meta_with_recall_matches.csv`

3. **Fuzzy and Semantic Matching, and export results:**  
   Use `MatchWithPretrainedModelandLLM.ipynb` to:
   - Compute fuzzy string matches (brand, title, description).
   - Compute semantic similarity matches using a pre-trained transformer model.
   - Verify and refine matches using a large language model.
   - Save the results to the file ``../Data/amazon_df_labels.csv``

**Note:** Both notebooks take a long time to run, and the second requires a CUDA-capable GPU. The output of  these files (``../Data/amazon_df_labels.csv``) is included in the github repository, so these files do not need to be run.

## Details

We start with two datasets: the incident and recall reports (2514 entries), and the amazon product metadata (633883 entries). We want to identify which products on the amazon product metadata dataset appear on the incident and recall reports dataset.

A typical entry in the incident report dataset (with certain columns omitted) is the following:

|                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|:----------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| product_description                           | Block Crayon http://blockcrayon.com/products.phpPurchased at Costco the Farm set it has bllock crayons that stack and includes animal shaped crayons. It came with a coloring book and about 14 animals and 30 or so blocks. All different colors. Block Crayon Club Pack 6020 and UPC Code:  62884506020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| product_category                              | Toys & Children                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| product_sub_category                          | Arts & Crafts                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| product_type                                  | Crayons or Chalk (5010)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| product_code                                  | 5010                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| manufacturer/importer/private_labeler_name    | WOOKY ENTERTAINMENT Inc                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| brand                                         | Block Crayon 6020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| model_name_or_number                          | nan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |


A typical entry in the amazon metadata dataset (with certain columns omitted) is the following:
|                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|:----------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| category        | ['Toys & Games', 'Grown-Up Toys', 'Games']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| description     | ["This screen is the perfect companion for those Dungeon Masters running the Storm King's Thunder adventure, or any journey along the Sword Coast and the North. The front features imposing images of giants, but reminds heroes that they can be defeated, while the back provides the DM with maps and tables to make overland travel as simple as possible."]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| title           | Dungeons &amp; Dragons - &quot;Storm Kings Thunder&quot; DM Screen                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| brand           | Gale Force Nine                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| feature         | ["This screen is the perfect companion for those Dungeon Masters running the Storm King's Thunder adventure", 'The front features imposing images of giants, but reminds heroes that they can be defeated', 'The back provides the DM with maps and tables to make overland travel as simple as possible']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| rank            | ['>#178,217 in Toys & Games (See Top 100 in Toys & Games)', '>#284 in Toys & Games > Grown-Up Toys > Games', '>#19,863 in Toys & Games > Games']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| main_cat        | Toys & Games                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| asin            | 0020232233                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

The ASIN (Amazon Standard Identification Number) is a unique number given to each amazon product. 

Our goal is to identify products that appear in both datasets, and label products in the amazon product dataset with a `1` if there is an incident report corresponding to that project, and a `0` otherwise.

We apply the following methods to do this:
1. **ASIN directly mentioned in the text.**
    
    For 64 incident reports, the report directly mentioned an ASIN in the text of the report. We extract those ASINs, and label the corresponding entries of the metadata dataset with a `1`.
2.  **`duckduckgo.com` search** (`duckduckgo_asins.ipynb`) 
    
    We define a function which does the following for each incident report:
    -   Concate the `brand`, `model_name_or_number`, and `product_description` to obtain a `query`.
    -   Search each `query` on `duckduckgo.com`, filtering to only results on `amazon.com`.
    -   For each result, we extract an asin and mark the corresponding entry of the amazon_metadata dataset with a `1`.

3. **Product recall matchings**
We match Amazon product listings to official product recall records by comparing product titles. The output is saved to `../Data/amazon_meta_with_recall_matches.csv`.
 - We first clean the title field in the recall database by removing generic/banned words (e.g., "recall", "hazard", "product", etc.)
 - We then apply `RapidFuzz` (a fuzzy matching module) to find matches between the recall titles and the `title` field in the amazon.com metadata.


4. **Similarity scores via text embeddings** (`MatchWithPretrainedModelandLLM.ipynb`)

    We use a pretrained model to find similarity scores between amazon products and incident reports/recalls.
    -   For each amazon product entry, we concatenate the `brand`, `title`, and `description` to obtain an `amazon_text` field.
    -   For each incident report, we concatentate the `Brand`, `Model Name or Number`, and `Product Description`, to obtain an `recalls_text` field.
    -   We use a pretrained model (`intfloat/e5-large-v2`) to find text embeddings of `amazon_text` and `recalls_text`. We compute the cosine similarity of all these entries.
    A positive match is obtained when the cosine similarity score is above a threshold.
    

5. **Fuzzy Matching** (`MatchWithPretrainedModelandLLM.ipynb`)
We use `RapidFuzz` (a fuzzy matching module) to compute similarity between:
        - The `brand` fields of the amazon items and incident reports.
        - The `Product Description` field of an incident report, and the `title` of each amazon product.
A positive match is obtained if these matches are above certain thresholds.

6. **Combining and verifying**
We combine all matches obtained from the above 5 methods, and use a LLM (Mixtral) to verify the matches.
The output is saved to a the file ``../Data/amazon_df_labels.csv``, whose columns are:
- `asin`: The asin of each product in the amazon.com dataset.
- `match`: Is a `1` if this item is matched to an incident report/recall, and a `0` otherwise.
- `incident_indices`: The indices of all entries in the incident report/recall dataset to which the product is matched.
